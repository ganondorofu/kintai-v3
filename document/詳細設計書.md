# 部活動勤怠管理システム 詳細設計書

## 1. はじめに

### 1.1 設計方針
- データベーススキーマを`members`（部員情報）と`attendance`（勤怠情報）に分割し、関心を分離する。
- 班や役職などの情報は`members`スキーマで管理し、勤怠関連の操作は`attendance`スキーマに限定する。
- Discord OAuth統合による安全な認証を維持する。
- キーボード操作優先のUI設計と既存kiosk画面との整合性を確保する。
- QRコード読み取り後の自動画面遷移による使いやすさを向上させる。

### 1.2 想定読者
- システム開発者
- 部活動管理者
- システム運用担当者

### 1.3 関連ドキュメント
- 部活動勤怠管理システム企画書
- 部活動勤怠管理システム要件定義書

## 2. データベース設計

### 2.1 スキーマ構成
- **members**: 部員の基本情報、班、役職などを管理するスキーマ。
- **attendance**: NFCカードIDと勤怠ログのみを管理するスキーマ。

### 2.2 テーブル構成図

#### `members` スキーマ
```
-- 部員の基本情報
users (ユーザーテーブル)
├── id (PK, uuid, references auth.users(id)) -- Supabase認証ID
├── display_name (unique, varchar) -- 表示用ID兼ニックネーム
├── discord_id (varchar, unique) -- Discord連携用（数字のみ）
├── generation (int) -- 期生
├── status (int) -- 0:中学生, 1:高校生, 2:OB/OG
├── student_number (varchar, nullable) -- 学籍番号
├── is_admin (boolean, default: false) -- 管理者権限
├── created_at, updated_at
└── deleted_at (timestamptz, nullable) -- 論理削除用

-- 班の情報
teams (班テーブル)
├── id (PK, int, generated by default as identity)
├── name (varchar, 班名)
├── discord_role_id (varchar, nullable) -- 対応DiscordロールID
└── created_at

-- メンバーと班の多対多関係
member_team_relations (所属関係テーブル)
├── member_id (PK, FK → members.users.id)
├── team_id (PK, FK → members.teams.id)
└── created_at

-- 各班の班長
team_leaders (班長テーブル)
├── team_id (PK, FK → members.teams.id)
├── member_id (PK, FK → members.users.id)

-- 期とDiscordロールの紐付け
generation_roles (期生ロールテーブル)
├── generation (PK, int)
└── discord_role_id (varchar, unique)
```

#### `attendance` スキーマ
```
-- カードIDとユーザーIDの紐付け
users (勤怠ユーザーテーブル)
├── id (PK, uuid, references members.users.id)
├── card_id (varchar, not null, unique) -- カードID
└── created_at, updated_at

-- 出退勤記録
attendances (出退勤記録)
├── id (PK, uuid)
├── user_id (FK → attendance.users.id)
├── type (varchar) -- 'in' or 'out'
├── timestamp (timestamptz) -- 打刻時刻
├── date (date) -- 日付（集計用インデックス）
└── created_at

-- 仮登録情報
temp_registrations (仮登録テーブル)
├── id (PK, uuid)
├── card_id (varchar, unique) -- カードID
├── qr_token (varchar, unique) -- QRコード用トークン
├── expires_at (timestamptz) -- 有効期限（30分）
├── is_used (boolean) -- 使用済みフラグ
├── accessed_at (timestamptz, nullable) -- QR読み取り時刻
└── created_at

-- ログ関連テーブル（変更なし）
user_edit_logs
daily_logout_logs
announcements
```

### 2.3 パフォーマンス設計
```sql
-- `members` スキーマ
CREATE INDEX idx_members_users_generation ON members.users (generation);
CREATE INDEX idx_members_users_discord_id ON members.users (discord_id);

-- `attendance` スキーマ
CREATE INDEX idx_attendances_date_user ON attendance.attendances (date, user_id);
CREATE INDEX idx_attendances_user_timestamp ON attendance.attendances (user_id, timestamp);
CREATE UNIQUE INDEX idx_attendance_users_card_id ON attendance.users (card_id);
```

## 3. API設計 (サーバーアクション)

### 3.1 認証・登録フロー

#### 新規登録フロー
1. **Kiosk側**：「/」キー押下 → 登録したいカードをタッチ
2. **Backend**: `createTempRegistration` 実行
    - `attendance.users` にカードIDが未登録か確認
    - `attendance.temp_registrations` に仮登録情報を作成
    - QRコード用トークンを返却
3. **Kiosk側**：QRコード生成・表示
4. **スマートフォン側**：QRコード読取 → `accessed_at` 更新 → Kiosk画面自動復帰
5. **スマートフォン側**：Discord OAuth認証
6. **スマートフォン側**：情報入力フォーム表示
7. **Backend**: `completeRegistration` 実行
    - `members.users` にユーザー情報を登録
    - `attendance.users` に `{id: ユーザーID, card_id: カードID}` を登録
    - `members.member_team_relations` に所属班情報を登録
    - `attendance.temp_registrations` を使用済みに更新

## 4. 画面設計

### 4.1 登録画面 (`/register/:token`)
- **入力項目**: 表示名、**学籍番号**、**身分(中学/高校/OG)**、期生、班
- 認証後にこれらの情報を入力するフォームを表示する。

### 4.2 管理者ダッシュボード (`/admin`)
- **ユーザー管理**: `members.users` テーブルと `attendance.users` テーブルを結合して情報を表示。カードIDの変更や、ユーザー情報の編集（所属班、管理者権限など）が可能。

## 5. 運用・監視設計

### 5.1 定期処理
- 変更なし

### 5.2 ログ・監視項目
- 変更なし

### 5.3 バックアップ・復旧
- 変更なし

### 5.4 セキュリティ対策
- **スキーマ分離**: `attendance`スキーマは勤怠専用とし、個人情報（`members`スキーマ）への直接アクセスを限定。RLS（Row Level Security）ポリシーを各スキーマに適切に設定する。
- その他変更なし。
